<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<api-group id="LITE_LOG_LOGIN" name="登录日志表" path="/lite/log/liteLogLogin">
    <api id="prepare" name="100.预处理" method="POST" path="prepare">
        <script><![CDATA[
			var id = uuid();
			var sql = 
			"""
				select
					'1' 
										,'0' rec_del_flag
			,#{body.recOrgId} rec_org_id				from
					 dual 
			""";
			
			var result = db.selectOne(sql);
			result.put("id",id);
			
			return result;
        ]]></script>
    </api>
    <api id="prepareCond" name="101.查询预处理" method="POST" path="prepareCond">
        <script><![CDATA[
			return {};	
        ]]></script>
    </api>
    <api id="get" name="110.查询记录" method="POST" path="get">
        <script><![CDATA[
			var sql = 
			"""
				select
					a.*
				from
					lite_log_login a
				where a.id = #{body.id}
			"""
			
			var result = db.selectOne(sql);
			
			return result;
        ]]></script>
    </api>
    <api id="copy" name="120.复制" method="POST" path="copy">
        <script><![CDATA[
			var sql =
			"""
				select
					a.*
				from
					lite_log_login a
				where a.id = #{body.rowId}
			"""
			
			var result = db.selectOne(sql);
			result.put("id",uuid());
			
			
			return result;
        ]]></script>
    </api>
    <api id="list" name="130.列表" method="POST" path="list">
        <script><![CDATA[
			var sql = 
			"""
				select
					a.*
				from
					lite_log_login a
				where a.rec_del_flag = '0' 
				
			"""
			
			var result = db.select(sql);
			
			return result;
        ]]></script>
    </api>
    <api id="tree" name="140.树列表" method="POST" path="tree">
        <script><![CDATA[
			var toTree = (list,pid) => select t.*,toTree(list,t.id) children from list t where t.pid = pid;
			
			var sql = 
			"""
				select
					a.*
				from
					lite_log_login a
				where a.rec_del_flag = '0' 
			  
				?{orderByColumn, order by a.${orderByColumn} ${direction == 0 ? 'asc' : direction == 1 ? 'desc' : ''}}
				
			"""
			
			var list = toTree(db.select(sql),'-1');
			
			var result = {
				list: list,
				total: list.getLength()
			};
			
			return result;
        ]]></script>
    </api>
    <api id="page" name="150.分页" method="POST" path="page">
        <script><![CDATA[
			var sql = 
			"""
				select
					a.*
				from
					lite_log_login a
				where a.rec_del_flag = '0'
				?{body.orgId, and a.rec_org_id =  #{body.orgId}}
				?{!body.orgId, and a.rec_org_id =  '0'}

				order by a.rec_create_dt desc
			"""
			
			var result = db.page(sql);
			
			return result;
        ]]></script>
    </api>
    <api id="insert" name="200.新增" method="POST" path="insert">
        <script><![CDATA[
			
			var fileds = [
			 {fieldName:"主键",fieldCode:"id"}
			 ,{fieldName:"登录账号",fieldCode:"loginCodeTxt"}
			 ,{fieldName:"失败密码",fieldCode:"failPwdTxt"}
			 ,{fieldName:"是否删除",fieldCode:"recDelFlag"}
			 ,{fieldName:"失败信息",fieldCode:"failTxt"}
			 ,{fieldName:"登录类型（成功、失败）",fieldCode:"loginTypeCode"}
			 ,{fieldName:"浏览器",fieldCode:"loginBrowserTxt"}
			 ,{fieldName:"操作系统",fieldCode:"loginOsTxt"}
			 ,{fieldName:"地理位置",fieldCode:"loginAddressTxt"}
			 ,{fieldName:"ip地址",fieldCode:"loginIpTxt"}
			 ,{fieldName:"token",fieldCode:"loginTokenTxt"}
			 ,{fieldName:"创建人ID",fieldCode:"recCreateId",fieldValue:SESSION_USER.id}
			 ,{fieldName:"创建人",fieldCode:"recCreateRef",fieldValue:SESSION_USER.userName}
			 ,{fieldName:"创建时间",fieldCode:"recCreateDt",fieldValue:now()}
			 ,{fieldName:"企业ID",fieldCode:"recOrgId",fieldValue:SESSION_USER.orgId}
			]
			
			var data = fillSqlEntity(body,fileds);
			
			return db.table("lite_log_login").primary("id").insert(data);
        ]]></script>
    </api>
    <api id="update" name="300.更新" method="POST" path="update">
        <script><![CDATA[
			
			var fileds = [
			 {fieldName:"主键",fieldCode:"id"}
			 ,{fieldName:"登录账号",fieldCode:"loginCodeTxt"}
			 ,{fieldName:"失败密码",fieldCode:"failPwdTxt"}
			 ,{fieldName:"是否删除",fieldCode:"recDelFlag"}
			 ,{fieldName:"失败信息",fieldCode:"failTxt"}
			 ,{fieldName:"登录类型（成功、失败）",fieldCode:"loginTypeCode"}
			 ,{fieldName:"浏览器",fieldCode:"loginBrowserTxt"}
			 ,{fieldName:"操作系统",fieldCode:"loginOsTxt"}
			 ,{fieldName:"地理位置",fieldCode:"loginAddressTxt"}
			 ,{fieldName:"ip地址",fieldCode:"loginIpTxt"}
			 ,{fieldName:"token",fieldCode:"loginTokenTxt"}
			 ,{fieldName:"创建人ID",fieldCode:"recCreateId"}
			 ,{fieldName:"创建人",fieldCode:"recCreateRef"}
			 ,{fieldName:"创建时间",fieldCode:"recCreateDt"}
			 ,{fieldName:"企业ID",fieldCode:"recOrgId"}
			]
			
			var data = fillSqlEntity(body,fileds);
			
			return db.table("lite_log_login").primary("id").withBlank().update(data);
        ]]></script>
    </api>
    <api id="sortUp" name="301.上移" method="POST" path="sortUp">
        <script><![CDATA[
			var sql = 
			"""
			    select
			        a.id,
			        a.gg_sort
			    from
			        lite_log_login a
			    where
			        a.gg_del_status = '0'
			        and a.gg_sort < ( select gg_sort from lite_log_login a where a.gg_del_status = '0' and a.id = #{id}  and a.rec_org_id =  #{recOrgId} )
			      
			    order by
			        a.gg_sort desc
			        limit 1
			"""
			
			var top = db.selectOne(sql)
			if(top){
			    sql = """
			        update lite_log_login a set gg_sort = #{top.ggSort} where id = #{id}
			    """
			    db.update(sql)
			    sql = """
			         update lite_log_login a set gg_sort = #{ggSort} where id = #{top.id}
			    """
			    db.update(sql)
			}
        ]]></script>
    </api>
    <api id="sortDown" name="302.下移" method="POST" path="sortDown">
        <script><![CDATA[
			var sql = 
			"""
			    SELECT
			        a.id,
			        a.gg_sort
			    from
			        lite_log_login a
			    where
			        a.gg_del_status = '0'
			        and a.gg_sort > ( select a.gg_sort from lite_log_login a where a.gg_del_status = '0' and a.id = #{id}   and a.rec_org_id =  #{recOrgId} )
			     
			   order by
			        a.gg_sort
			        limit 1
			"""
			
			var top = db.selectOne(sql)
			if(top){
			    sql = """
			        update lite_log_login a set gg_sort = #{top.ggSort} where id = #{id}
			    """
			    db.update(sql)
			    sql = """
			        update lite_log_login a set gg_sort = #{ggSort} where id = #{top.id}
			    """
			    db.update(sql)
			}
        ]]></script>
    </api>
    <api id="reorder" name="303.重新排序" method="POST" path="reorder">
        <script><![CDATA[
			import log
			
			var sql = 
			"""
			    select
			        a.*
			    from
			        lite_log_login a
			    where a.rec_del_flag = '0' 
			     and a.rec_org_id =  #{body.recOrgId} 
			      
			    ?{orderByColumn, order by a.${orderByColumn} ${direction == 0 ? 'asc' : direction == 1 ? 'desc' : ''}}
			    
			"""
			
			var result = db.select(sql);
			
			var sort = 5;
			result.each(data => {
			    var newData = {
			        id:data.id,
			        :sort
			    }
			    db.table("lite_log_login").primary("id").update(newData);
			    sort = sort + 5;
			})
			
			return 1;
        ]]></script>
    </api>
    <api id="delete" name="400.删除" method="POST" path="delete">
        <script><![CDATA[
			
			var result = db.table("lite_log_login").where().eq("id",body.id).delete();
			
			return result;
			
        ]]></script>
    </api>
    <api id="deletes" name="401.批量删除" method="POST" path="deletes">
        <script><![CDATA[
			body.ids.each(id => {
			
			    var result = db.table("lite_log_login").where().eq("id",id).delete();
			
			    return result;
			})
			
			return 1;
        ]]></script>
    </api>
    <api id="comList" name="500.组件下拉列表" method="POST" path="comList">
        <script><![CDATA[
			var sql = 
			"""
			    select
			        a.*
			    from
			        lite_log_login a
			    where a.rec_del_flag = '0' 
			     
			     
			"""
			
			var result = db.select(sql);
			
			return result;
        ]]></script>
    </api>
    <api id="comTree" name="501.组件树列表" method="POST" path="comTree">
        <script><![CDATA[
			var toTree = (list,pid) => select t.*,toTree(list,t.id) children from list t where t.pid = pid;
			
			var sql = 
			"""
			    select
			        a.*
			    from
			        lite_log_login a
			    where a.rec_del_flag = '0' 
			     
			    
			"""
			
			
			var datas = db.select(sql);
			datas.add(
			    {
			        id:'-1'
			        ,pid:'0'
			        ,nameTxt:'根栏目'
			    }
			)
			
			var list = toTree(datas,'0');
			
			var result = {
			    list: list,
			    total: list.getLength()
			};
			
			return result;
        ]]></script>
    </api>
</api-group>
