<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<api-group id="LITE_NAV" name="产品导航" path="/lite/nav/liteNav">
    <api id="prepare" name="100.预处理" method="POST" path="prepare">
        <script><![CDATA[
			var id = uuid();
			var sql = 
			"""
				select
					'1' rec_valid_flag
					,ifnull((select max(rec_sort_num) + 5 from lite_nav a where a.rec_del_flag = '0'  ),5) rec_sort_num					,'0' rec_del_flag
			,#{body.pid} pid				from
					 dual 
			""";
			
			var result = db.selectOne(sql);
			result.put("id",id);
			
			return result;
        ]]></script>
    </api>
    <api id="prepareCond" name="101.查询预处理" method="POST" path="prepareCond">
        <script><![CDATA[
			return {};	
        ]]></script>
    </api>
    <api id="get" name="110.查询记录" method="POST" path="get">
        <script><![CDATA[
			var sql = 
			"""
				select
					a.*
				from
					lite_nav a
				where a.id = #{body.id}
			"""
			
			var result = db.selectOne(sql);
			
			return result;
        ]]></script>
    </api>
    <api id="copy" name="120.复制" method="POST" path="copy">
        <script><![CDATA[
			var sql =
			"""
				select
					a.*
				from
					lite_nav a
				where a.id = #{body.rowId}
			"""
			
			var result = db.selectOne(sql);
			result.put("id",uuid());
			result.put("recSortNum",result.get("recSortNum")+1);
			
			return result;
        ]]></script>
    </api>
    <api id="list" name="130.列表" method="POST" path="list">
        <script><![CDATA[
			var sql = 
			"""
				select
					a.*
				from
					lite_nav a
				where a.rec_del_flag = '0' 
				
			"""
			
			var result = db.select(sql);
			
			return result;
        ]]></script>
    </api>
    <api id="tree" name="140.树列表" method="POST" path="tree">
        <script><![CDATA[
			var toTree = (list,pid) => select t.*,toTree(list,t.id) children from list t where t.pid = pid;
			
			var sql = 
			"""
				select
					a.*
				from
					lite_nav a
				where a.rec_del_flag = '0' 
			  
				?{orderByColumn, order by a.${orderByColumn} ${direction == 0 ? 'asc' : direction == 1 ? 'desc' : ''}}
				?{!orderByColumn, order by a.rec_sort_num asc}
			"""
			
			var list = toTree(db.select(sql),'-1');
			
			var result = {
				list: list,
				total: list.getLength()
			};
			
			return result;
        ]]></script>
    </api>
    <api id="page" name="150.分页" method="POST" path="page">
        <script><![CDATA[
			var sql = 
			"""
				select
					a.*
				from
					lite_nav a
				where a.rec_del_flag = '0'
				and a.pid =  #{body.pid}
				  
				?{orderByColumn, order by a.${orderByColumn} ${direction == 0 ? 'asc' : direction == 1 ? 'desc' : ''}}
				?{!orderByColumn, order by a.rec_sort_num asc}
			"""
			
			var result = db.page(sql);
			
			return result;
        ]]></script>
    </api>
    <api id="insert" name="200.新增" method="POST" path="insert">
        <script><![CDATA[
			
			var fileds = [
			 {fieldName:"菜单id",fieldCode:"id"}
			 ,{fieldName:"父节点id",fieldCode:"pid"}
			 ,{fieldName:"导航编码",fieldCode:"codeTxt"}
			 ,{fieldName:"导航名称",fieldCode:"nameTxt"}
			 ,{fieldName:"导航别名",fieldCode:"aliasTxt"}
			 ,{fieldName:"导航图标",fieldCode:"iconTxt"}
			 ,{fieldName:"导航url",fieldCode:"urlTxt"}
			 ,{fieldName:"组件",fieldCode:"componentTxt"}
			 ,{fieldName:"导航类型编码",fieldCode:"typeCode"}
			 ,{fieldName:"导航类型",fieldCode:"typeRef"}
			 ,{fieldName:"导航链接类型编码",fieldCode:"linkTypeCode"}
			 ,{fieldName:"导航链接类型",fieldCode:"linkTypeRef"}
			 ,{fieldName:"导航提示说明",fieldCode:"tipsTxt"}
			 ,{fieldName:"打开方式，0：iframe  1：新标签页",fieldCode:"openModeCode"}
			 ,{fieldName:"是否显示：1显示，0不显示",fieldCode:"showFlag"}
			 ,{fieldName:"是否缓存：1缓存，0不缓存",fieldCode:"keepAliveFlag"}
			 ,{fieldName:"排序号",fieldCode:"recSortNum"}
			 ,{fieldName:"备注",fieldCode:"recRemarksTxt"}
			 ,{fieldName:"是否有效",fieldCode:"recValidFlag"}
			 ,{fieldName:"是否删除",fieldCode:"recDelFlag"}
			 ,{fieldName:"是否系统保留",fieldCode:"recSysFlag"}
			 ,{fieldName:"创建人ID",fieldCode:"recCreateId",fieldValue:SESSION_USER.id}
			 ,{fieldName:"创建人",fieldCode:"recCreateRef",fieldValue:SESSION_USER.nameTxt}
			 ,{fieldName:"创建时间",fieldCode:"recCreateDt",fieldValue:now()}
			 ,{fieldName:"更新人ID",fieldCode:"recUpdateId"}
			 ,{fieldName:"更新人",fieldCode:"recUpdateRef"}
			 ,{fieldName:"更新时间",fieldCode:"recUpdateDt"}
			]
			
			var data = fillSqlEntity(body,fileds);
			
			return db.table("lite_nav").primary("id").insert(data);
        ]]></script>
    </api>
    <api id="update" name="300.更新" method="POST" path="update">
        <script><![CDATA[
			
			var fileds = [
			 {fieldName:"菜单id",fieldCode:"id"}
			 ,{fieldName:"父节点id",fieldCode:"pid"}
			 ,{fieldName:"导航编码",fieldCode:"codeTxt"}
			 ,{fieldName:"导航名称",fieldCode:"nameTxt"}
			 ,{fieldName:"导航别名",fieldCode:"aliasTxt"}
			 ,{fieldName:"导航图标",fieldCode:"iconTxt"}
			 ,{fieldName:"导航url",fieldCode:"urlTxt"}
			 ,{fieldName:"组件",fieldCode:"componentTxt"}
			 ,{fieldName:"导航类型编码",fieldCode:"typeCode"}
			 ,{fieldName:"导航类型",fieldCode:"typeRef"}
			 ,{fieldName:"导航链接类型编码",fieldCode:"linkTypeCode"}
			 ,{fieldName:"导航链接类型",fieldCode:"linkTypeRef"}
			 ,{fieldName:"导航提示说明",fieldCode:"tipsTxt"}
			 ,{fieldName:"打开方式，0：iframe  1：新标签页",fieldCode:"openModeCode"}
			 ,{fieldName:"是否显示：1显示，0不显示",fieldCode:"showFlag"}
			 ,{fieldName:"是否缓存：1缓存，0不缓存",fieldCode:"keepAliveFlag"}
			 ,{fieldName:"排序号",fieldCode:"recSortNum"}
			 ,{fieldName:"备注",fieldCode:"recRemarksTxt"}
			 ,{fieldName:"是否有效",fieldCode:"recValidFlag"}
			 ,{fieldName:"是否删除",fieldCode:"recDelFlag"}
			 ,{fieldName:"是否系统保留",fieldCode:"recSysFlag"}
			 ,{fieldName:"创建人ID",fieldCode:"recCreateId"}
			 ,{fieldName:"创建人",fieldCode:"recCreateRef"}
			 ,{fieldName:"创建时间",fieldCode:"recCreateDt"}
			 ,{fieldName:"更新人ID",fieldCode:"recUpdateId",fieldValue:SESSION_USER.id}
			 ,{fieldName:"更新人",fieldCode:"recUpdateRef",fieldValue:SESSION_USER.nameTxt}
			 ,{fieldName:"更新时间",fieldCode:"recUpdateDt",fieldValue:now()}
			]
			
			var data = fillSqlEntity(body,fileds);
			
			return db.table("lite_nav").primary("id").withBlank().update(data);
        ]]></script>
    </api>
    <api id="sortUp" name="301.上移" method="POST" path="sortUp">
        <script><![CDATA[
			var sql = 
			"""
			    select
			        a.id,
			        a.gg_sort
			    from
			        lite_nav a
			    where
			        a.gg_del_status = '0'
			        and a.gg_sort < ( select gg_sort from lite_nav a where a.gg_del_status = '0' and a.id = #{id}  and a.pid =  #{pid} )
			      
			    order by
			        a.gg_sort desc
			        limit 1
			"""
			
			var top = db.selectOne(sql)
			if(top){
			    sql = """
			        update lite_nav a set gg_sort = #{top.ggSort} where id = #{id}
			    """
			    db.update(sql)
			    sql = """
			         update lite_nav a set gg_sort = #{ggSort} where id = #{top.id}
			    """
			    db.update(sql)
			}
        ]]></script>
    </api>
    <api id="sortDown" name="302.下移" method="POST" path="sortDown">
        <script><![CDATA[
			var sql = 
			"""
			    SELECT
			        a.id,
			        a.gg_sort
			    from
			        lite_nav a
			    where
			        a.gg_del_status = '0'
			        and a.gg_sort > ( select a.gg_sort from lite_nav a where a.gg_del_status = '0' and a.id = #{id}   and a.pid =  #{pid} )
			     
			   order by
			        a.gg_sort
			        limit 1
			"""
			
			var top = db.selectOne(sql)
			if(top){
			    sql = """
			        update lite_nav a set gg_sort = #{top.ggSort} where id = #{id}
			    """
			    db.update(sql)
			    sql = """
			        update lite_nav a set gg_sort = #{ggSort} where id = #{top.id}
			    """
			    db.update(sql)
			}
        ]]></script>
    </api>
    <api id="reorder" name="303.重新排序" method="POST" path="reorder">
        <script><![CDATA[
			import log
			
			var sql = 
			"""
			    select
			        a.*
			    from
			        lite_nav a
			    where a.rec_del_flag = '0' 
			     and a.pid =  #{body.pid} 
			      
			    ?{orderByColumn, order by a.${orderByColumn} ${direction == 0 ? 'asc' : direction == 1 ? 'desc' : ''}}
			    ?{!orderByColumn, order by a.rec_sort_num asc}
			"""
			
			var result = db.select(sql);
			
			var sort = 5;
			result.each(data => {
			    var newData = {
			        id:data.id,
			        recSortNum:sort
			    }
			    db.table("lite_nav").primary("id").update(newData);
			    sort = sort + 5;
			})
			
			return 1;
        ]]></script>
    </api>
    <api id="delete" name="400.删除" method="POST" path="delete">
        <script><![CDATA[
			
			var result = db.table("lite_nav").where().eq("id",body.id).delete();
			
			return result;
			
        ]]></script>
    </api>
    <api id="deletes" name="401.批量删除" method="POST" path="deletes">
        <script><![CDATA[
			body.ids.each(id => {
			
			    var result = db.table("lite_nav").where().eq("id",id).delete();
			
			    return result;
			})
			
			return 1;
        ]]></script>
    </api>
    <api id="comList" name="500.组件下拉列表" method="POST" path="comList">
        <script><![CDATA[
			var sql = 
			"""
			    select
			        a.*
			    from
			        lite_nav a
			    where a.rec_del_flag = '0' 
			     
			     ?{!orderByColumn, order by a.rec_sort_num asc}
			"""
			
			var result = db.select(sql);
			
			return result;
        ]]></script>
    </api>
    <api id="comTree" name="501.组件树列表" method="POST" path="comTree">
        <script><![CDATA[
			var toTree = (list,pid) => select t.*,toTree(list,t.id) children from list t where t.pid = pid;
			
			var sql = 
			"""
			    select
			        a.*
			    from
			        lite_nav a
			    where a.rec_del_flag = '0' 
			     
			    ?{!orderByColumn, order by a.rec_sort_num asc}
			"""
			
			
			var datas = db.select(sql);
			datas.add(
			    {
			        id:'-1'
			        ,pid:'0'
			        ,nameTxt:'根栏目'
			    }
			)
			
			var list = toTree(datas,'0');
			
			var result = {
			    list: list,
			    total: list.getLength()
			};
			
			return result;
        ]]></script>
    </api>
</api-group>
